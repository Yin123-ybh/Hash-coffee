<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.sky.mapper.CouponMapper">

    <select id="pageQuery" resultType="com.sky.entity.Coupon">
        select c.*, ct.name as template_name, u.name as user_name
        from coupon c
        left join coupon_template ct on c.template_id = ct.id
        left join user u on c.user_id = u.id
        <where>
            <if test="code != null and code != ''">
                and c.code like concat('%', #{code}, '%')
            </if>
            <if test="userId != null">
                and c.user_id = #{userId}
            </if>
            <if test="templateId != null">
                and c.template_id = #{templateId}
            </if>
            <if test="status != null">
                and c.status = #{status}
            </if>
            <if test="startTime != null">
                and c.create_time &gt;= #{startTime}
            </if>
            <if test="endTime != null">
                and c.create_time &lt;= #{endTime}
            </if>
        </where>
        order by c.create_time desc
    </select>

    <insert id="insertBatch">
        insert into coupon (template_id, user_id, code, status, create_time, update_time)
        values
        <foreach collection="coupons" item="coupon" separator=",">
            (#{coupon.templateId}, #{coupon.userId}, #{coupon.code}, #{coupon.status}, #{coupon.createTime}, #{coupon.updateTime})
        </foreach>
    </insert>

    <select id="getByUserId" resultType="com.sky.entity.Coupon">
        select * from coupon 
        where user_id = #{userId}
        <if test="status != null">
            and status = #{status}
        </if>
        order by create_time desc
    </select>

    <select id="getById" resultType="com.sky.entity.Coupon">
        select * from coupon where id = #{id}
    </select>

    <update id="updateStatus">
        update coupon 
        set status = #{status}, 
            order_id = #{orderId}, 
            used_time = #{usedTime}, 
            update_time = now()
        where id = #{id}
    </update>

    <select id="countByUserIdAndTemplateId" resultType="int">
        select count(*) from coupon 
        where user_id = #{userId} and template_id = #{templateId}
    </select>

    <select id="getExpiredCoupons" resultType="com.sky.entity.Coupon">
        select c.* from coupon c
        join coupon_template ct on c.template_id = ct.id
        where c.status = 0 and ct.end_time &lt; #{currentTime}
    </select>

    <update id="updateExpiredCoupons">
        update coupon set status = 2, update_time = #{currentTime}
        where id in
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

</mapper>
